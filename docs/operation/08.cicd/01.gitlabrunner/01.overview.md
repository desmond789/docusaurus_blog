---
title: gitlab runner 基础知识
---
# 简介

CI/CD 代表 **持续集成（Continuous Integration）**和 **持续交付（Continuous Delivery）**的缩写。这是一种软件开发实践，旨在通过自动化和频繁的代码集成、测试以及部署，提高软件开发的效率和质量。

1. **持续集成（Continuous Integration，CI）：** 开发人员在代码仓库中提交代码时，自动触发构建和测试过程。这有助于确保新代码与现有代码协同工作，并且不会引入破坏性的错误。持续集成的目标是频繁地整合代码，以便及早地发现和解决问题。
2. **持续交付（Continuous Delivery，CD）：** 一旦代码通过了持续集成的测试阶段，它可以自动地部署到测试环境或者生产环境中。持续交付的目标是确保软件随时都可以交付给用户，以便快速响应需求变化。
3. **持续部署（Continuous Deployment）：** 这是 CI/CD 中的一种更进一步的实践，它涉及到将通过持续集成和持续交付的代码自动部署到生产环境，从而使新功能和改进可以立即被最终用户使用。

# GitLab CI/CD

GitLab CI/CD 是 GitLab 提供的一套集成的持续集成和持续交付工具，用于自动化构建、测试和部署应用程序。它与 GitLab 的源代码仓库集成在一起，为开发团队提供了在代码提交时自动执行各种操作的能力。GitLab CI/CD 可以帮助团队加速软件交付流程，确保代码质量，以及简化部署过程。

## 主要组成

* **Runner：** 用于执行构建和部署的运行时环境，可以在不同的操作系统和架构上运行。GitLab Runner 通过与 GitLab 服务器通信，接收作业（Job）并执行相应的操作。
* **Pipeline：** 定义了一系列的阶段（Stages）和作业（Jobs），用于描述 CI/CD 流水线。流水线中的每个阶段和作业都可以执行一系列的操作，例如构建、测试、部署等。
* **Artifact：** 构建过程中生成的中间产物，可以被传递到后续的作业中，或者存储供后续的部署使用。

## 工作原理

1. **触发器：** CI/CD 流水线的开始通常由代码仓库中的代码提交触发。这可以是通过开发人员直接提交代码，或者是通过合并请求（Merge Request）的方式。当有新的提交或合并请求时，GitLab 触发 CI/CD 流水线的执行。
2. **流水线定义：** CI/CD 流水线由一系列的阶段（Stages）和作业（Jobs）组成，这些定义在代码仓库中的 `.gitlab-ci.yml` 配置文件中。该文件描述了每个阶段和作业的执行步骤、依赖关系和其他配置。
3. **Runner 的注册和选择：** 在 CI/CD 流水线执行之前，需要有至少一个 GitLab Runner 注册到 GitLab 服务器。Runner 可以是直接运行在物理机器上，也可以是运行在容器中。当 CI/CD 流水线触发时，GitLab 会选择一个可用的 Runner 来执行流水线中的作业。
4. **作业执行：** 流水线中的作业会按照定义的顺序依次执行。每个作业运行在独立的环境中，可以包括构建、测试、部署等步骤。Runner 负责从代码仓库获取代码，执行作业，并将结果报告回 GitLab 服务器。
5. **Artifact 的传递：** 在作业执行过程中，可以生成一些中间产物（Artifact），比如编译后的二进制文件、打包后的应用程序等。这些 Artifact 可以被传递给后续的作业，实现流水线中各个阶段之间的数据共享。
6. **持续集成（CI）阶段：** 在 CI 阶段，通常会包括代码编译、单元测试、代码静态分析等操作。这有助于确保新代码的质量，并及早地发现潜在的问题。
7. **持续交付（CD）阶段：** 如果 CI 阶段通过，流水线可以进入 CD 阶段。这个阶段可能包括集成测试、部署到预生产环境、自动化测试等。如果一切顺利，代码可以自动地部署到生产环境。
8. **通知和报告：** 在整个流水线执行完成后，GitLab CI/CD 会生成相应的报告，包括每个作业的执行结果、代码覆盖率、部署状态等。这些报告可以通过 GitLab 的界面查看，也可以通过邮件等方式通知相关的团队成员。
9. **自动化和反馈循环：** 整个流水线的自动化过程不仅提高了软件交付的效率，还为团队提供了及时的反馈。如果有问题出现，团队可以及时修复，并迅速重新触发 CI/CD 流水线。

# **GitLab Runner**

## 简介

GitLab Runner 是 GitLab CI/CD 的执行引擎，负责运行 CI/CD 流水线中定义的作业。它可以在不同的环境中运行，包括本地开发机、云服务、容器等。Runner 会与 GitLab 服务器通信，接收作业并执行相关的操作。

## 主要特点

1. **容器化支持：** Runner 可以在容器中运行，支持 Docker 和 Kubernetes。这使得它能够轻松地与容器化的应用程序和微服务架构集成，实现更好的灵活性和资源隔离。
2. **并行执行：** GitLab Runner 允许并行执行多个作业，提高了整个 CI/CD 流水线的效率。它能够在多个执行环境中同时运行作业，从而更快地完成构建、测试和部署等任务。
3. **作业的隔离性：** 每个作业都在独立的环境中运行，防止不同作业之间相互影响。这种隔离性确保了 CI/CD 流水线中的安全性和可靠性。
4. **Artifact 支持：** Runner 可以传递构建过程中生成的 Artifact 给后续的作业。这有助于确保流水线中的各个阶段之间能够有效地共享数据和结果。
5. **灵活的配置：** Runner 的配置可以通过 GitLab CI/CD 的配置文件进行定义。这种灵活性使得 Runner 能够适应不同的项目和流水线需求。
6. **自动注册：** Runner 支持自动注册到 GitLab 服务器，简化了配置和管理的过程。新的 Runner 可以轻松地加入 CI/CD 系统，而不需要手动的管理步骤。
7. **缓存机制：** Runner 支持缓存构建过程中的依赖项，减少了构建时间。通过智能地使用缓存，Runner 能够更加高效地执行作业。

## 主要功能

* **执行作业：** 根据 GitLab CI/CD 流水线的定义，Runner 在相应的环境中执行各个作业，例如构建、测试、部署等。
* **环境隔离：** 每个作业都运行在独立的环境中，防止不同作业之间的相互影响。
* **Artifact 传递：** 将产生的 Artifact（例如编译后的二进制文件、打包后的应用程序等）传递给后续的作业，确保流水线中各个阶段的协同工作。R

# 安装gitlab和runner

创建名为 gitlab.yaml 的yaml格式文件，类似如下：

```
version: '3.6'
services:
  gitlab:
    image: 'gitlab/gitlab-ce:latest'
    container_name: gitlab_server
    restart: always
    hostname: 'gitlab.badhydra.com'		#主機名，請確認DNS可以正確解析
    networks:
      gitlab:
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.badhydra.com'
        # Add any other gitlab.rb configuration here, each on its own line
    ports:
      - '88:80'
      - '4433:443'
      - '2205:22'
    volumes:
      - '/data/app/gitlab/conf:/etc/gitlab'	#用于存储应用程序数据
      - '/data/app/gitlab/logs:/var/log/gitlab'	#用于存储日志
      - '/data/app/gitlab/data:/var/opt/gitlab'	#用于存储 GitLab 配置文件
    shm_size: '128m'	

  gitlab-runner:
    image: 'gitlab/gitlab-runner:latest'
    container_name: gitlab_runner
    restart: always
    networks:
      gitlab_network:
    volumes:
      - /data/app/gitlab_runner/run/docker.sock:/var/run/docker.sock
      - /data/app/gitlab_runner/conf/:/etc/gitlab-runner

networks:
    gitlab:
```

使用docker compose运行 gitlab_runner.yaml

```
docker compose -f ./gitlab_runner.yaml up -d
```

#安裝過程可能需要幾分鐘，可以使用 docker logs 查看

```
docker logs -f gitlab_server
docker logs -f gitlab_runner
```

## 登录gitlab

查看gitlab的密碼

```
docker exec -it gitlab_server grep 'Password:' /etc/gitlab/initial_root_password
```

使用浏览器登录gitlab

```
http://gitlab.xxxx.com		#内网可以用IP登录 http://xxxxxx:88
```

# 类型和状态

### 类型

1. **Shared Runner（共享 Runner）：**
   * 共享 Runner 是由 GitLab 提供并在多个项目之间共享使用的 Runner。这种类型的 Runner 适用于小型团队或者对资源要求较低的项目。
   * 简单易用，无需为每个项目单独配置 Runner。
2. **Specific Runner（特定 Runner）：**
   * 特定 Runner 是为特定项目配置的 Runner，其资源和配置仅供该项目使用。每个项目可以配置自己的特定 Runner。
   * 可以根据项目的需要进行定制化配置，独立的资源隔离。
3. **Group Runner（组 Runner）：**
   * 组 Runner 是为 GitLab 项目组配置的 Runner，可以在项目组内的所有项目中共享使用。
   * 适用于需要在项目组内多个项目之间共享资源的情况。
4. **Instance-level Runner（实例级别 Runner）：**
   * 实例级别 Runner 是配置在整个 GitLab 实例上的 Runner，可供所有项目使用。
   * 可以为整个 GitLab 实例提供全局性的 Runner，适用于大型企业级部署。

### 状态

1. **Active（活跃）：**
   * Runner 处于活跃状态表示它可以接收并执行作业。这是正常运行状态。
2. **Paused（暂停）：**
   * Runner 处于暂停状态表示它不会接收新的作业。可以通过暂停 Runner 来阻止新的作业执行，但不影响已经在运行的作业。
3. **Locked（锁定）：**
   * Runner 处于锁定状态表示它被管理员手动锁定，不接收新的作业。这可能是由于维护、升级或其他管理操作而导致的。
4. **Untagged（未标记）：**
   * Runner 未被标记为可接收作业的任何特定标签。Untagged Runner 可以接收任意标签的作业。
5. **Tagged（已标记）：**
   * Runner 被标记为可接收特定标签的作业。标签通常用于指定某个作业需要在具有特定特性的 Runner 上执行。
6. **Online（在线）/Offline（离线）：**
   * Runner 处于在线状态表示它可以接收作业，处于离线状态表示它不能接收作业。这反映了 Runner 是否能够正常连接到 GitLab 服务器。

# Runner注册

**步骤：**

1. 创建 runner
2. 注册 runner





# Reference Links：

#学习视频参考：

https://www.bilibili.com/video/BV18y4y1S7VC

#笔记参考：

http://docs.idevops.site/gitlabci/

#runner 安装

https://docs.gitlab.com/runner/install/docker.html

#runner注册
