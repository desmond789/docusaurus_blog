---
title: 5.Redis哨兵模式
---
## Redis哨兵模式

Redis哨兵模式（Sentinel）是一种用于监控和管理Redis实例的系统。它可以自动进行故障检测、故障转移和提供其他监控功能。

Redis通过使用哨兵（Sentinel）来实现高可用性。哨兵监视Redis节点，当主节点失效时，它会自动将一个从节点升级为主节点。

### **哨兵模式概述**

在哨兵模式中，有一个或多个哨兵（Sentinel）进程运行，它们负责监视Redis主服务器和从服务器的状态。当监测到主服务器不可用时，哨兵会协调执行故障转移，将一个从服务器提升为新的主服务器。

### **哨兵的主要任务**

* **监控：** 哨兵定期检查Redis实例的健康状况。
* **通知：** 当发现主服务器不可用时，哨兵会通知其他哨兵和相关的客户端。
* **故障转移：** 在主服务器不可用时，哨兵会选举一个新的主服务器，进行自动故障转移。
* **配置提醒：** 哨兵可以在配置变更时通知其他哨兵和客户端。

### **工作流程**

哨兵通过以下步骤工作：

1. **监控：** 哨兵周期性地向Redis实例发送PING命令检查健康状况。
2. **判断主服务器状态：** 当主服务器不可用时，哨兵开始选举一个新的主服务器。
3. **故障转移：** 哨兵向其他从服务器发送SLAVEOF命令，将其中一个从服务器升级为新的主服务器。
4. **通知：** 在监测到状态变更时，哨兵通过发布订阅模式（Pub/Sub）通知其他哨兵和客户端。

### **配置哨兵**

哨兵的配置文件通常包含以下信息：

* `sentinel monitor`: 监控的主服务器名和IP地址。
* `sentinel down-after-milliseconds`: 主服务器在多长时间内被判定为不可用。
* `sentinel failover-timeout`: 故障转移的超时时间。
* `sentinel parallel-syncs`: 每次故障转移可以同步的从服务器数量。

### **运行哨兵**

启动哨兵的命令

```
redis-sentinel /path/to/sentinel.conf
```

### **监控哨兵**

可以通过连接到哨兵的监听端口（默认26379）并发送命令来获取哨兵的状态信息。

### 示例配置文件

```
# sentinel.conf

# 指定监控的主服务器
sentinel monitor mymaster 127.0.0.1 6379 2

# 设置在2秒内没有响应则判定为主服务器不可用
sentinel down-after-milliseconds mymaster 2000

# 设置故障转移的超时时间为30秒
sentinel failover-timeout mymaster 30000

# 设置每次故障转移可以同步的从服务器数量
sentinel parallel-syncs mymaster 1
```

在上述配置中，哨兵监控一个名为 `mymaster` 的主服务器，主服务器的IP地址是 `127.0.0.1`，端口是 `6379`。在2秒内没有响应，则判定为主服务器不可用，超时时间为30秒。每次故障转移最多同步一个从服务器。这只是一个简单的示例，实际配置需要根据具体情况进行调整。
